---
title: World Happiness EDA
author: Avery Rogers
date: '2021-03-26'
slug: attempted-post-test
---

I used the World Happiness Report for all measures related to happiness, and the World Bank 2019 population data for country populations.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = FALSE, warning = FALSE)
```

```{r results=FALSE, warning=FALSE, message=FALSE}
# Libraries
library(tidyverse)

# Parameters
current_ladders_data <- "~/Downloads/world_happiness/current_ladders.csv"
historical_ladders_data <- "~/Downloads/world_happiness/historical_ladders.csv"
current_mortality_data <- "~/Downloads/world_happiness/current_mortality.csv"
world_pop_data <- "~/Downloads/world_happiness/world_pop.csv"
#===============================================================================
divide_1000 <- function(x, na.rm=FALSE) {
  x / 1000 
}

make_decimal <- function(x, na.rm=FALSE) {
  as.integer(str_sub(x, 3, -1)) / 1000 
}
# Code
```

```{r results=FALSE, warning=FALSE, message=FALSE}
current_ladders <- read_csv(current_ladders_data)

current_ladders <- 
  current_ladders %>% 
  rename(
    country = `Country name`,
    region = `Regional indicator`,
    ladder_score = `Ladder score`,
    std_error_ladder_score = `Standard error of ladder score`,
    log_gdp_pc = `Logged GDP per capita`,
    social_support = `Social support`,
    healthy_life_expectancy = `Healthy life expectancy`,
    freedom_of_choice = `Freedom to make life choices`,
    generosity = Generosity,
    perceptions_corruption = `Perceptions of corruption`,
    ladder_dystopia = `Ladder score in Dystopia`,
    explained_log_gdp_pc = `Explained by: Log GDP per capita`,
    explained_social_support = `Explained by: Social support`,
    explained_life_expectancy = `Explained by: Healthy life expectancy`,
    explained_freedom_choices = `Explained by: Freedom to make life choices`,
    explained_generosity = `Explained by: Generosity`,
    explained_corruption = `Explained by: Perceptions of corruption`,
    dystopia_residual = `Dystopia + residual`
  ) %>% 
  mutate_at(
    vars(social_support, freedom_of_choice, generosity, perceptions_corruption), 
    make_decimal
    ) %>% 
  mutate_at(
    vars(
      ladder_score, 
      log_gdp_pc,
      healthy_life_expectancy
    ), 
    divide_1000
  )

current_ladders

```

```{r}
world_pop <- 
  read_csv(world_pop_data, skip = 4) %>% 
  select(country = `Country Name`, pop_2019 = `2019`) 

world_pop
```

```{r}
current_ladders <- 
  current_ladders %>% 
  left_join(world_pop, by = "country") 

current_ladders <- 
  current_ladders %>% 
  filter(!is.na(pop_2019))
```


```{r results=FALSE, warning=FALSE, message=FALSE}
current_ladders 

current_ladders %>% 
  arrange(desc(pop_2019)) %>% 
  ggplot(aes(log_gdp_pc, ladder_score)) + 
  geom_smooth() +
  geom_point(aes(fill = region, size = pop_2019), pch = 21) +
  scale_radius(range = c(2, 16)) +
  scale_y_continuous(breaks = c(3, 4, 5, 6, 7, 8)) +
  labs(
    x = "Log GDP Per Capita",
    y = "Happiness Ladder Score",
    title = "Wealthier Countries are Happier on Average",
    fill = "Region",
    subtitle = "Higher log GDP per capita correlates with higher happiness ladder scores"
  ) +
  guides(size = FALSE)

current_ladders %>% 
  ggplot(aes(healthy_life_expectancy, ladder_score)) + 
  geom_point() +
  geom_smooth()

current_ladders %>% 
  ggplot(aes(social_support, ladder_score)) + 
  geom_point() +
  geom_smooth()

current_ladders %>% 
  ggplot(aes(freedom_of_choice, ladder_score)) + 
  geom_point() +
  geom_smooth()

current_ladders %>% 
  ggplot(aes(generosity, ladder_score)) + 
  geom_point() +
  geom_smooth()

current_ladders %>% 
  ggplot(aes(perceptions_corruption, ladder_score)) + 
  geom_point() +
  geom_smooth()
```

We notice that log GDP per capita, healthy life expectancy, social support, and freedom of choice have fairly uniformly positive impacts on subjective well-being. Generosity and perceptions of corruption have less obvious relationships to subjective well-being across countries in 2020.

Let us look at effects over time.

```{r results=FALSE, warning=FALSE, message=FALSE}
historical_ladders <- read_csv(historical_ladders_data)

historical_ladders <- 
  historical_ladders %>% 
  select(
    country = `Country name`,
    year,
    ladder_score = `Life Ladder`,
    log_gdp_pc = `Log GDP per capita`,
    social_support = `Social support`,
    healthy_life_expectancy = `Healthy life expectancy at birth`,
    freedom_of_choice = `Freedom to make life choices`,
    generosity = Generosity,
    perceptions_corruption = `Perceptions of corruption`
  ) %>% 
  mutate_at(
    vars(social_support, freedom_of_choice, generosity, perceptions_corruption), 
    make_decimal
    ) %>% 
  mutate_at(
    vars(
      ladder_score, 
      log_gdp_pc,
      healthy_life_expectancy
    ), 
    divide_1000
  )
```

```{r results=FALSE, warning=FALSE, message=FALSE}
historical_ladders
```
Let's see which countries got progressively better over this time period: 

```{r warning=FALSE, message=FALSE}
historical_ladders_change <- 
  historical_ladders %>% 
  group_by(country) %>% 
  filter(year %in% c(min(year), max(year))) %>% 
  mutate(dif_ladder = ladder_score - lag(ladder_score, default = first(ladder_score))) %>% 
  mutate(first_year = lag(year, default = first(year))) %>% 
  filter(year == max(year)) %>% 
  ungroup()

historical_ladders_change %>% 
  select(country, year, first_year, dif_ladder) %>% 
  arrange(desc(dif_ladder)) %>% 
  top_n(10)

historical_ladders_change %>% 
  select(country, year, first_year, dif_ladder) %>% 
  arrange(dif_ladder) %>% 
  head(10)
  
```

Now let's look at the regions and how they changed over this time period, on average: 

```{r, fig.height = 5}
current_ladders_region <- 
  current_ladders %>% 
  select(country, region)

historical_ladders %>% 
  left_join(current_ladders_region, by = "country") %>% 
  group_by(region, year) %>% 
  summarize(mean_ladder = mean(ladder_score)) %>% 
  filter(!is.na(region)) %>% 
  ggplot(aes(year, mean_ladder, color = region)) +
  geom_point() +
  geom_line() +
  theme(legend.position="bottom", legend.box = "horizontal") +
  guides(col = guide_legend(nrow = 2))
```


